<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../fs-metrics/fs-metrics.html">
<link rel="import" href="../fs-inner-html/fs-inner-html.html">
<link rel="import" href="../fs-dialog/fs-modal-dialog.html">
<link rel="import" href="../fs-dialog/fs-anchored-dialog.html">
<link rel="import" href="../fs-icon/fs-icon.html">

<dom-module id="fs-album-slideshow">
  <template>
    <style include='fs-styles'>
      .flex-row-between {
        display: flex;
        justify-content: space-between;
        align-content: center;
      }
      .flex-column {
        display: flex;
        justify-content: flex-start;
        flex-direction: column;
        align-content: center;
      }
      .flex-column span {
        margin-bottom: 10px;
        display: inline-block;
      }
      .flex-column span fs-icon {
        vertical-align: sub;
      }
      .flex-column small:first-of-type {
        margin-bottom: 15px;
      }
      .flex-column small:last-of-type {
        margin-bottom: 5px;
      }
      .toggleSelects {
        -webkit-user-select: none;
        user-select: none;
      }
      #slideshowOptions .fs-dialog__close {
        display: none;
      }
      #slideshowOptions #dialogBody {
        max-width: 260px;
      }
      #slideShow #dialogBody {
        padding: 0;
      }
      #slideShow .fs-dialog__close {
        z-index: 1000;
        color: #ffffff;
      }
      .play-slideshow-btn-icon {
        vertical-align: sub;
        margin-right: 4px;
      }
      .slide-container {
        background-color: #333331;
        display: flex;
        height: 100%;
        width: 100%;
        justify-content: center;
        align-items: center;
      }
      .slide-img {
        max-width: 90vw;
        max-height: 90vw;
      }
      *[hidden] {
        display: none !important;
      }
    </style>
    <!-- Slideshow modal -->
    <fs-modal-dialog id="slideShow" keep-fullscreen>
      <div id="dialogBody" class="fs-dialog__body">
        <div class="slide-container">
          <img class="slide-img" src="[[getCurrentSlideSrc(currentSlideIndex, artifacts.length)]]" alt="[[getCurrentSlideAltText(currentSlideIndex, artifacts.length)]]"/>
        </div>
      </div>
    </fs-modal-dialog>
    <!-- Slideshow Config modal -->
    <fs-anchored-dialog id="slideshowOptions" forced-pointer-direction="up" no-fullscreen-mobile on-fs-dialog-confirm="beginSlideshow">
      <div id="dialogBody" class="fs-dialog__body">
        <div class="flex-column">
          <small>[[i18n('slideshow_options_desc')]]</small>
          <span on-click="togglePlayAudio" class="toggleSelects" role="switch">
            <fs-icon icon="toggle-off-state-small" hidden="[[playAudio]]"></fs-icon>
            <fs-icon icon="toggle-on-state-small" hidden="[[!playAudio]]"></fs-icon>
            [[i18n('slideshow_options_play_audio')]]
          </span>
          <span on-click="toggleLoopSlideshow" class="toggleSelects" role="switch">
            <fs-icon icon="toggle-off-state-small" hidden="[[loopSlideshow]]"></fs-icon>
            <fs-icon icon="toggle-on-state-small" hidden="[[!loopSlideshow]]"></fs-icon>
            [[i18n('slideshow_options_loop_slideshow')]]
          </span>
          <small>
            <fs-inner-html value="[[handleOptionsCountDisplay(artifacts.length, i18n)]]"></fs-inner-html>
          </small>
        </div>
        <button class="fs-button fs-button--recommended" data-dialog-confirm>
          <span>
            <fs-icon icon="play-small" color="var(--fs-color-white)" class="play-slideshow-btn-icon"></fs-icon>[[i18n('play_slideshow')]]
          </span>
        </button>
      </div>
    </fs-anchored-dialog>
  </template>
</dom-module>
<script>
(function() {
  // Set up dialog as a "global" dialog to prevent overlapping elements (on top of dialog)
  FS.dialog.register('fs-album-slideshow');

  Polymer({

    is: 'fs-album-slideshow',

    behaviors: [
      WCI18n(),
      FsBehaviors.Metrics
    ],

    properties: {
      albumSlideshowEx: {
        type: Boolean,
        value: function(){ return FS.showEx('albumSlideshowEx'); }
      },
       artifacts: {
        type: Array,
        value: function() { return []; }
      },
      /**
       * * Not sure I need the "album" data yet...
       */
      _album: {
        type: Object,
        value: function() { return {}; }
      },
      playAudio: {
        type: Boolean,
        value: false
      },
      loopSlideshow: {
        type: Boolean,
        value: false
      },
      // All time listed below is in Milliseconds
      slideshowTransitionTime: {
        type: Number,
        value: 700
      },
      slideDisplayTime: {
        type: Number,
        value: 4000
      },
      totalSlideshowDuration: {
        type: Number,
        value: 0
      },
      currentSlideIndex: {
        type: Number,
        value: 0
      },
      activeInterval: {
        type: Number,
        value: 0
      }
    },

    openSlideshowOptions: function(data) {
      if (!data.album || !data.artifacts || !data.artifacts.length) return;
      this._album = data.album;
      this.totalSlideshowDuration = 0;
      this.validateArtifacts(data.artifacts);
      this.$.slideshowOptions.open({ attachToElement: data.target });
    },
    
    validateArtifacts: function(artifacts) {
      // Don't need to check for 'Phaudios' since they will always be included with a photo filter 
      const validGroup = artifacts.filter(item => (item.category === 'IMAGE' && item.contentCategory === 'PHOTO'));
      
      this.set('artifacts', validGroup.slice(0));
    },

    nextSlide: function() {
      // invoke fade animation
      if ((this.currentSlideIndex + 1) >= this.artifacts.length) {
        clearInterval(this.activeInterval);
      } else {
        this.currentSlideIndex += 1;
      }
    },
    prevSlide: function() {
      // invoke fade animation
      if ((this.currentSlideIndex - 1) < 0) {
        clearInterval(this.activeInterval);
      } else {
        this.currentSlideIndex -= 1;
      }
    },

    runSlides: function() {
      this.activeInterval = setInterval(this.nextSlide.bind(this), this.slideDisplayTime);
    },

    beginSlideshow: function(e) {
      if (e.target.id === 'slideshowOptions') {
        this.$.slideshowOptions.close();
        this.runSlides();
        this.$.slideShow.open();
      }
    },

    getAudioDuration: function(audioUrl) {
      const audio = new Audio(audioUrl)
      audio.addEventListener('loadedmetadata', () => {
        this.totalSlideshowDuration += (audio.duration + this.slideshowTransitionTime);
      })
    },
    calcSlideshowDuration: function(listLength) {
      this.artifacts.forEach(item => {
        if (item.associatedArtifacts && item.associatedArtifacts.length && items.associatedArtifacts[0].category === 'AUDIO') {
          this.getAudioDuration(item.url);
        } else {
          this.totalSlideshowDuration += (this.slideDisplayTime + this.slideshowTransitionTime);
        }
      }) 
    },

    formatDisplayTime: function(timeInMS) {
      const minutes = (Math.floor(Math.floor(timeInMS / 1000) / 60) % 60);
      const seconds = (Math.floor(timeInMS / 1000) % 60);
      const formattedSeconds = (seconds < 10) ? `0${seconds}` : seconds;
      return `${minutes}:${formattedSeconds}`;
    },

    handleOptionsCountDisplay: function(listLength, i18n) {
      if (!i18n) return;
      let text = i18n('slideshow_options_length');
      if (text) {
        this.calcSlideshowDuration(listLength);

        text = text.replace('{count}', `<span>${listLength}</span>`);
        text = text.replace('{min}', `<span>${this.formatDisplayTime(this.totalSlideshowDuration)}</span>`);
        return text;
      }
    },
    getCurrentSlideSrc: function(_currentSlideIndex) {
      if (!this.artifacts || !this.artifacts.length) return;
      return this.artifacts[_currentSlideIndex].url;
    },
    getCurrentSlideAltText: function(_currentSlideIndex) {
      if (!this.artifacts || !this.artifacts.length) return;
      return this.artifacts[_currentSlideIndex].title || '';
    },
    togglePlayAudio: function() {
      this.playAudio = !this.playAudio;
    },
    toggleLoopSlideshow: function() {
      this.loopSlideshow = !this.loopSlideshow;
    }
  });
})();
</script>
